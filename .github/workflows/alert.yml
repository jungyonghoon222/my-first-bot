#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import os
import time
import ccxt
import schedule
import telebot

# â”€â”€â”€ â¶ í™˜ê²½ë³€ìˆ˜ì—ì„œ í…”ë ˆê·¸ë¨ ì •ë³´ ê°€ì ¸ì˜¤ê¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
TG_TOKEN   = os.getenv("TG_TOKEN")
TG_CHAT_ID = os.getenv("TG_CHAT_ID")
if not TG_TOKEN or not TG_CHAT_ID:
    raise RuntimeError("í™˜ê²½ë³€ìˆ˜ TG_TOKEN, TG_CHAT_ID ë¥¼ ì„¤ì •í•˜ì„¸ìš”.")

bot = telebot.TeleBot(TG_TOKEN)

# â”€â”€â”€ â· Bitget USDT ì„ ë¬¼ê±°ë˜ì†Œ ê°ì²´ ìƒì„± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
exchange = ccxt.bitget({
    'enableRateLimit': True,
    'options': {
        'defaultType': 'future',  # USDT ì„ ë¬¼
    },
})

def check_entry():
    """
    1. USDT ë§ˆì¼“ ì‹¬ë³¼ ìƒìœ„ 40ì¢…ëª© ì¡°íšŒ
    2. ê° ì‹¬ë³¼ 1ë¶„ë´‰ 21ê°œ ì½ì–´ì„œ Turtle20 ëŒíŒŒ ì²´í¬
    3. ëŒíŒŒ ì‹œ SL=1%â†“, TP=2%â†‘ ì„ ë¶™ì—¬ í…”ë ˆê·¸ë¨ìœ¼ë¡œ ì „ì†¡
    """
    try:
        # 1) ì „ì²´ í‹°ì»¤ ë¶ˆëŸ¬ì™€ì„œ USDT ì„ ë¬¼ë§Œ í•„í„°ë§
        tickers = exchange.fetch_tickers()
        usdt_symbols = [
            s for s,info in tickers.items()
            if s.endswith('/USDT') and info.get('quoteVolume', 0) > 0
        ]
        # 2) ê±°ë˜ëŸ‰ ìƒìœ„ 40 ì¢…ëª©
        top40 = sorted(
            usdt_symbols,
            key=lambda s: tickers[s].get('quoteVolume', 0),
            reverse=True
        )[:40]

        for sym in top40:
            try:
                # 3) 1ë¶„ë´‰ 21ê°œ
                ohlcv  = exchange.fetch_ohlcv(sym, '1m', limit=21)
                closes = [c[4] for c in ohlcv]
                entry     = closes[-1]
                prev20_hi = max(closes[:-1])

                # 4) Turtle20 ëŒíŒŒ ì‹œ ì•Œë¦¼
                if entry > prev20_hi:
                    sl  = entry * 0.99
                    tp  = entry * 1.02
                    msg = (
                        f"ğŸ”” {sym} ë¡± ì§„ì… ì‹ í˜¸ ğŸ””\n"
                        f"Entry : {entry:.6f}\n"
                        f"SL    : {sl:.6f}\n"
                        f"TP    : {tp:.6f}\n"
                        f"ì´ìœ   : Turtle20 1ë¶„ë´‰ ê³ ê°€ ëŒíŒŒ"
                    )
                    bot.send_message(TG_CHAT_ID, msg)
                    time.sleep(0.5)  # ìŠ¤íŒ¸ ë°©ì§€
            except Exception as e_sym:
                print(f"[ì‹¬ë³¼ ì˜¤ë¥˜] {sym} â†’ {e_sym}")
    except Exception as e:
        print(f"[ì²´í¬ í•¨ìˆ˜ ì˜¤ë¥˜] {e}")

# â”€â”€â”€ â¸ 1ë¶„ë§ˆë‹¤ ì‹¤í–‰ ìŠ¤ì¼€ì¤„ ë“±ë¡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
schedule.every(1).minutes.do(check_entry)

# â”€â”€â”€ â¹ ë©”ì¸ ì§„ì…ì  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if __name__ == "__main__":
    bot.send_message(TG_CHAT_ID, "âœ… ì•Œë¦¼ë´‡ ê°€ë™ ì‹œì‘!")
    while True:
        schedule.run_pending()
        time.sleep(1)
